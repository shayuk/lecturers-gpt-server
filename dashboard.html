<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×œ×•×— × ×™×”×•×œ â€“ ×§×‘×¦×™× ×©×”×•×¢×œ×•</title>

  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #f8fafc;
      padding: 20px;
      direction: rtl;
    }
    h1 {
      color: #2563eb;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sub {
      color: #64748b;
      margin-bottom: 14px;
      font-size: 0.95rem;
    }
    .loading {
      color: #555;
      margin-top: 10px;
    }
    .error {
      color: #b91c1c;
      margin-top: 10px;
      font-weight: 600;
    }
    .success {
      color: #059669;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      background: white;
    }
    th, td {
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      text-align: center;
    }
    th {
      background: #e0e7ff;
      font-weight: 700;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #1e3a8a;
      font-size: 0.85rem;
    }
    .topbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    input[type="text"]{
      padding: 8px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      min-width: 220px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .config-warning {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      color: #92400e;
    }
    .config-warning strong {
      display: block;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>
  <h1>ğŸ“Š ×œ×•×— × ×™×”×•×œ â€“ ×§×‘×¦×™× ×©×”×•×¢×œ×• <span class="pill">Firestore / rag_chunks</span></h1>
  <div class="sub">×× ××ª ×¨×•××” "Missing permissions" â€“ ×–×” ××•××¨ ×©××™×Ÿ ×”×ª×—×‘×¨×•×ª ××• ×©×”-Rules ×œ× ×¤×•×¨×¡××•.</div>

  <div id="configWarning" class="config-warning" style="display:none">
    <strong>âš ï¸ ××–×”×¨×”: ×”×’×“×¨×•×ª Firebase</strong>
    <div id="configWarningText"></div>
  </div>

  <div class="topbar">
    <label>
      ×¡×™× ×•×Ÿ ×œ×¤×™ ××§×•×¨/×§×•×¨×¡:
      <input id="search" type="text" placeholder="×œ××©×œ: ×©×™×¢×•×¨ 1 ××• statistics" />
    </label>
    <button id="refreshBtn">×¨×¢× ×•×Ÿ</button>
  </div>

  <div id="status" class="loading">××ª×—×‘×¨ ×œ-Firebaseâ€¦</div>

  <table id="results" style="display:none">
    <thead>
      <tr>
        <th>ğŸ“„ ××§×•×¨</th>
        <th>ğŸ“š ×§×•×¨×¡</th>
        <th>ğŸ”¢ ××¡×¤×¨ ×§×˜×¢×™×</th>
        <th>ğŸ“… ×”×¢×œ××” ××—×¨×•× ×”</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    /*********************************************************
     * 1) Firebase Config â€“ ×–×” ××¤×ª×— ×©×œ Firebase (Web API Key)
     *    ×œ× ×œ×”×“×‘×™×§ ×›××Ÿ OpenAI key ×‘×©×•× ××¦×‘.
     *    
     *    ××™×š ×œ××¦×•× ××ª ×”-API Key:
     *    1. ×œ×š×™ ×œ-Firebase Console: https://console.firebase.google.com
     *    2. ×‘×—×¨×™ ××ª ×”×¤×¨×•×™×§×˜: lecturers-gpt-auth
     *    3. ×œ×š×™ ×œ-Project Settings (âš™ï¸) > General
     *    4. ×’×œ×œ×™ ×œ××˜×” ×œ-"Your apps" > Web app
     *    5. ×”×¢×ª×™×§×™ ××ª ×”-apiKey ××”-config object
     *********************************************************/
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_WEB_API_KEY", // âš ï¸ ×¦×¨×™×š ×œ×”×—×œ×™×£ ×œ××¤×ª×— ×”×××™×ª×™!
      authDomain: "lecturers-gpt-auth.firebaseapp.com",
      projectId: "lecturers-gpt-auth"
    };

    // ×‘×“×™×§×” ×©×”××¤×ª×— ×”×•×’×“×¨
    if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_FIREBASE_WEB_API_KEY") {
      document.getElementById('configWarning').style.display = 'block';
      document.getElementById('configWarningText').innerHTML = 
        'âš ï¸ ×¦×¨×™×š ×œ×”×’×“×™×¨ ××ª Firebase Web API Key ×‘×§×•×“!<br>' +
        '×œ×›×™ ×œ-Firebase Console > Project Settings > General > Web app > ×”×¢×ª×™×§×™ ××ª ×”-apiKey';
    }

    try {
      firebase.initializeApp(firebaseConfig);
    } catch (err) {
      console.error("Firebase initialization error:", err);
      document.getElementById('status').textContent = "âŒ ×©×’×™××” ×‘××ª×—×•×œ Firebase: " + err.message;
      document.getElementById('status').className = "error";
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    const statusEl = document.getElementById('status');
    const tableEl = document.getElementById('results');
    const tbodyEl = tableEl.querySelector('tbody');
    const searchEl = document.getElementById('search');
    const refreshBtn = document.getElementById('refreshBtn');

    let groupedRows = [];
    let autoRefreshInterval = null;

    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = type || "loading";
    }

    function renderTable(filterText = "") {
      tbodyEl.innerHTML = "";

      const q = (filterText || "").trim().toLowerCase();
      const rows = q
        ? groupedRows.filter(r =>
            (r.source || "").toLowerCase().includes(q) ||
            (r.course_name || "").toLowerCase().includes(q)
          )
        : groupedRows;

      if (rows.length === 0) {
        tableEl.style.display = "none";
        if (groupedRows.length === 0) {
          setStatus("×œ× × ××¦××• × ×ª×•× ×™× ×œ×”×¦×’×”.", "loading");
        } else {
          setStatus("×œ× × ××¦××• × ×ª×•× ×™× ×ª×•×××™× ×œ×¡×™× ×•×Ÿ.", "loading");
        }
        return;
      }

      for (const row of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(row.source || "â€”")}</td>
          <td>${escapeHtml(row.course_name || "â€”")}</td>
          <td>${row.count || 0}</td>
          <td>${row.lastUploadedAt ? formatDate(row.lastUploadedAt) : "â€”"}</td>
        `;
        tbodyEl.appendChild(tr);
      }

      setStatus(`âœ… × ××¦××• ${rows.length} ×¨×©×•××•×ª`, "success");
      tableEl.style.display = "table";
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(date) {
      if (!date) return "â€”";
      try {
        if (date.toDate) {
          // Firestore Timestamp
          return date.toDate().toLocaleString('he-IL');
        }
        if (date instanceof Date) {
          return date.toLocaleString('he-IL');
        }
        return new Date(date).toLocaleString('he-IL');
      } catch (e) {
        return String(date);
      }
    }

    async function loadData() {
      refreshBtn.disabled = true;
      tableEl.style.display = "none";
      tbodyEl.innerHTML = "";
      setStatus("×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦", "loading");

      try {
        // ×‘×“×™×§×” ×©×”××©×ª××© ××—×•×‘×¨
        const currentUser = auth.currentUser;
        if (!currentUser) {
          setStatus("âŒ ×œ× ××—×•×‘×¨×ª ×œ-Firebase. ×× ×¡×” ×œ×”×ª×—×‘×¨ ××—×“×©...", "error");
          await auth.signInAnonymously();
          return;
        }

        // ×§×¨×™××” ×-rag_chunks. ×”-Rules ×¦×¨×™×›×™× ×œ××¤×©×¨ read ××—×¨×™ auth.
        // ×”×§×˜× ×ª×™ ×-500 ×œ-200 ×›×“×™ ×œ×”×¤×—×™×ª ×§×¨×™××•×ª ×œ-Firestore
        const snapshot = await db.collection("rag_chunks").limit(200).get();

        if (snapshot.empty) {
          groupedRows = [];
          renderTable(searchEl.value);
          setStatus("×œ× × ××¦××• × ×ª×•× ×™× ×‘-rag_chunks.", "loading");
          refreshBtn.disabled = false;
          return;
        }

        const grouped = {};

        snapshot.forEach(doc => {
          const d = doc.data();
          const key = `${d.course_name || ""}__${d.source || ""}`;

          if (!grouped[key]) {
            grouped[key] = {
              source: d.source || "â€”",
              course_name: d.course_name || "â€”",
              count: 0,
              lastUploadedAt: null
            };
          }

          grouped[key].count++;

          // ×˜×™×¤×•×œ ×‘-uploaded_at - ×™×›×•×œ ×œ×”×™×•×ª string, Timestamp, ××• ×‘×ª×•×š metadata
          let uploadedAt = d.uploaded_at;
          if (!uploadedAt && d.metadata && d.metadata.uploaded_at) {
            uploadedAt = d.metadata.uploaded_at;
          }

          if (uploadedAt) {
            let date;
            try {
              if (uploadedAt.toDate) {
                // Firestore Timestamp
                date = uploadedAt.toDate();
              } else if (uploadedAt instanceof Date) {
                date = uploadedAt;
              } else {
                date = new Date(uploadedAt);
              }

              if (!isNaN(date.getTime())) {
                if (!grouped[key].lastUploadedAt || date > grouped[key].lastUploadedAt) {
                  grouped[key].lastUploadedAt = date;
                }
              }
            } catch (e) {
              console.warn("Error parsing date:", uploadedAt, e);
            }
          }
        });

        groupedRows = Object.values(grouped)
          .sort((a, b) => {
            const ta = a.lastUploadedAt ? a.lastUploadedAt.getTime() : 0;
            const tb = b.lastUploadedAt ? b.lastUploadedAt.getTime() : 0;
            return tb - ta;
          });

        renderTable(searchEl.value);
        refreshBtn.disabled = false;
      } catch (err) {
        console.error("Error loading data:", err);
        let errorMsg = "âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×.";
        
        if (err.code === 'permission-denied' || err.message?.includes('permission')) {
          errorMsg += "<br><br>ğŸ”’ ×‘×¢×™×™×ª ×”×¨×©××•×ª Firestore:<br>" +
            "1. ×•×“××™ ×©-Anonymous Authentication ××•×¤×¢×œ ×‘-Firebase Console<br>" +
            "2. ×•×“××™ ×©-Firestore Rules ×¤×•×¨×¡××• (allow read: if request.auth != null)<br>" +
            "3. ×œ×›×™ ×œ-Firebase Console > Authentication > Sign-in method > Anonymous > Enable";
        } else if (err.code === 'unauthenticated') {
          errorMsg += "<br><br>ğŸ” ×‘×¢×™×™×ª ×”×ª×—×‘×¨×•×ª:<br>" +
            "×•×“××™ ×©-Anonymous Authentication ××•×¤×¢×œ ×‘-Firebase Console";
        } else {
          errorMsg += "<br><br>×¤×¨×˜×™×: " + err.message;
        }
        
        statusEl.innerHTML = errorMsg;
        statusEl.className = "error";
        refreshBtn.disabled = false;
      }
    }

    // 2) ×”×ª×—×‘×¨×•×ª ×× ×•× ×™××™×ª (×—×™×™×‘ ×œ×”×™×•×ª Enabled ×‘-Authentication)
    auth.signInAnonymously()
      .then((userCredential) => {
        console.log("âœ… Signed in anonymously:", userCredential.user.uid);
        setStatus("âœ… ××—×•×‘×¨×ª ×œ-Firebase. ×˜×•×¢×Ÿ × ×ª×•× ×™×...", "success");
        loadData();
        
        // ×‘×•×˜×œ× ×• ××ª ×”-polling ×”××•×˜×•××˜×™ ×›×“×™ ×œ×”×¤×—×™×ª ×§×¨×™××•×ª ×œ-Firestore
        // ×¨×¢× ×•×Ÿ ×¨×§ ×™×“× ×™ ×“×¨×š ×›×¤×ª×•×¨ "×¨×¢× ×•×Ÿ"
      })
      .catch((err) => {
        console.error("Auth error:", err);
        let errorMsg = "âŒ ×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ-Firebase.";
        
        if (err.code === 'auth/operation-not-allowed') {
          errorMsg += "<br><br>âš ï¸ Anonymous Authentication ×œ× ××•×¤×¢×œ!<br>" +
            "×œ×›×™ ×œ-Firebase Console > Authentication > Sign-in method > Anonymous > Enable";
        } else if (err.code === 'auth/api-key-not-valid') {
          errorMsg += "<br><br>âš ï¸ Firebase API Key ×œ× ×ª×§×™×Ÿ!<br>" +
            "×•×“××™ ×©×”××¤×ª×— ×‘×§×•×“ × ×›×•×Ÿ (Firebase Console > Project Settings > Web app)";
        } else {
          errorMsg += "<br><br>×¤×¨×˜×™×: " + err.message;
        }
        
        statusEl.innerHTML = errorMsg;
        statusEl.className = "error";
      });

    // UI events
    searchEl.addEventListener("input", () => renderTable(searchEl.value));
    refreshBtn.addEventListener("click", loadData);
  </script>
</body>
</html>
